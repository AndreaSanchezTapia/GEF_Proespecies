---
title: "Produto2"
author: "Andrea Sánchez-Tapia"
date: "3/29/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = F, message = F)
```

```{r remedy001}
library(readxl)
library(readr)
library(dplyr)
library(stringr)
library(knitr)
p1 <- read_xlsx("data/dados_formatados/produto1/produto1_Lista_de_espécies.xlsx",
                 sheet = 2)

```


## Lista de espécies

A lista preliminar que foi entregue como Produto1 continha 
`r length(unique(p1$especie_original))` nomes originais únicos (ou seja, depois 
de unificar as bases de dados e levando em conta que elas poderiam aparecer em 
várias das bases), correspondentes a `r length(unique(p1$nome_aceito_correto))`
nomes aceitos corretos. 

Agrupando pelos nomes corretos, a classificação prévia das espécies como aptas, inaptas e precisando de examinação, esses nomes se classificam assim: 

```{r remedy002}

p2 <- read_csv("output/p2/03_resumo_anotado.csv")
knitr::kable(count(p2, elegivel_produto_1))
```


```{r, eval = F}
#Os motivos para a classificação são os seguintes:
p2 %>%
#  filter(elegivel_produto_1 != "inapta") %>%
 # select(elegivel_produto_1, notas) %>%
  count(elegivel_produto_1, notas_all) %>%
  arrange(desc(n)) %>% 
  knitr::kable()
```

## Reformatação da base de dados

A tabela de espécies do Produto 1 foi reformatada para obtermos uma linha por nome aceito e correto. Os nomes originais se encontram na coluna `nomes_originais` e as fontes que os citam, na coluna `fontes`, e as demais colunas foram mantidas. A nova lista contém `r nrow(p2)` linhas, a comparação das `r nrow(p1)` da lista original.

## Busca de sinônimos

```{r}
especies <- p2 %>%
  filter(elegivel_produto_1 != "inapta") %>%
  #select(nome_aceito_correto) %%
  filter(!is.na(nome_aceito_correto)) %>%
  distinct(nome_aceito_correto) %>%
  pull()


ignorar <- str_detect(especies, "subsp.") |
  str_detect(especies, "var.")
```

Dentre as `r length(especies)` espécies classificadas como aptas e examinar  `r sum(ignorar)` correspondem a subespécies e variedades. Estes nomes infraespecíficos não puderam (*) ser checados por sinônimos pela Flora do Brasil. 

```{r}
especies <- especies[!ignorar]
```

Os demais `r length(unique(especies))` nomes foram checados por sinônimos perante a Flora do Brasil. 

Para cada nome, os sinônimos pela FB2020 foram extraídos, e todos os nomes foram utilizados para realizar o download dos registros de herbário em speciesLink e rgbif.

{comentário sobre as demais fontes de dados. simbiota nunca teve, jabot está sem API}

## Download de ocorrências

Para cada nome aceito e correto, e cada sinônimo aceito pela FB2020, foram requeridos os registros nas bases de dados SpeciesLink e GBIF (Global Biodiversity Information Facility).

```{r remedy003}
occs <- list.files("output/p2/occs/",recursive = T, full.names = T, pattern = ".csv")
gbif <- occs[stringr::str_detect(occs, "splink", negate = T)] %>% basename() %>% stringr::str_remove(".csv")
splink <- occs[stringr::str_detect(occs, "gbif", negate = T)] %>% basename() %>% stringr::str_remove(".csv")

```

Os erros de download em ambas as bases foram corrigidos manualmente. No entanto, algumas buscas não retornaram resultados, principalmente devido a nomes ausentes das bases de dados.No final da fase de download, `r length(gbif)` espécies têm dados provindos de GBIF e `r length(splink)` têm dados provindos de SpeciesLink.


## Especies com download em ambas bases de dados

```{r remedy004}
tb <- tibble(sp = especies) %>% 
full_join(tibble(sp = gbif, source = "gbif")) %>%
  full_join(tibble(sp = splink, source = "splink"), by = "sp") %>% arrange(sp)
  rmarkdown::paged_table(tb)
```

```{r remedy005}
nodata <- tb %>% filter(is.na(source.x) & is.na(source.y)) %>% pull(sp)
```

As espécies seguintes nao têm dados para nenhuma das fontes de dados: _`r nodata`_.

## Checagem geográfica

O _shapefile_ para conferência da ocorrência de cada espécie no estado de São Paulo
foi baixado do endereço: https://www.ibge.gov.br/geociencias/organizacao-do-territorio/malhas-territoriais/15774-malhas.html?edicao=30138&t=downloads -  Seção Geocièncias > Organização do território > Malhas territoriais > municipio_2020 > UFs > SP > SP_UF_2020.zip.

Os demais _shapefiles_ foram fornecidos pela contratante e correspondem aos municípios do território 20 e à RBCV.

Para todas as espécies, as ocorrências provindas de SpeciesLink e GBIF foram cruzadas com os _shapefiles_, criando vetores lógicos que respondem à pergunta x tabela cruza com y shape? Por exemplo, sp_splink corresponde às espécies com alguma ocorrência dentro do Estado de São Paulo para a fonte de dados SpeciesLink.

### Seleção preliminar de espécies

As espécies cujos registros foram selecionados são espécies que cumprem os critérios seguintes:


- Foram consideradas aptas ou examinar no Produto 1 (as inaptas foram removidas)
- Têm alguma categoria de ameaça (VU, EN, CR) ou DD, ou NT em qualquer das avaliações realizadas e revisadas no Produto 1. 
- Para as espécies Aptas, a Flora do Brasil afirma que há algum registro no Estado. Essas espécies não foram verificadas geográficamente mesmo que os dados de ocorrência georreferenciados não apontem para a presença da espécie no estado. 
- Para as espécies Examinar, a Flora do Brasil apontava que a espécie não se encontra no Estado. Essas espécies foram verificadas geograficamente, eliminando espécies que não tivessem registros comprovados no Estado. 

```{r remedy006}
p3 <- read_csv("output/p2/p2_selecionadas.csv")
p3 %>%
     count(
       elegivel_produto_1,
       cat_ameaca_geral,
       splink_sp | gbif_sp
      ) %>% arrange(desc(n)) %>%
  kable()

```

## 

- [x] Quem é ameaçada?
- [x] Quem fura ou nao os shapes
- [x] Qual  a lista final de especies das quais vamos retornar ocorrencias. 
    1. Entra (por cat_ameaca)
    2. Entra iif&& Aptas segundo a FB (mesmo que nao cruze)
    3. qualquer coisa que cruze e que seja entra (por cat_ameaca)
    3. Com ocorrencias
    

- [ ] Juntar* sim ou sim para cada especie final selecionada a base de gbif e a base de species link 
 - Juntar bases de species link e gbif para uma especie só: formatar os campos!!!!

